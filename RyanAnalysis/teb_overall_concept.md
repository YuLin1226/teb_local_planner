```
所以 TEB 的邏輯有點像是，我先有了一個 global plan，然後先做一些轉換處理。
接著我根據這個 plan 去建他的 Pose 和 TimeDiff 的頂點。

然後開始建立一些約束條件：例如某些頂點在優化後要盡量靠近初始的軌跡點（viapoints）
例如頂點之間必須滿足速度約束等等。

然後優化後，我的頂點組會被更新。
接著我依據更新後的頂點，以及設定的 lookahead distance 來決定我機器人的移動速度？

請問我的邏輯有哪部份是說錯的嘛？
```


您的理解基本上是正確的，讓我對 TEB Local Planner 的完整邏輯流程做一個更詳細的說明：

1. **初始軌跡獲取**：
   - 從 global planner 獲取全局路徑
   - 對全局路徑進行預處理（如簡化、平滑等）

2. **TEB 結構建立**：
   - 將預處理後的路徑轉換為 TEB 的初始軌跡
   - 創建交替的 PoseVertex 和 TimeDiffVertex 頂點序列

3. **約束條件建立**：
   - 添加各種約束邊（edges）到優化問題中：
     - 路徑跟隨約束（與初始軌跡/via points 保持一致）
     - 運動學約束（速度、加速度限制等）
     - 碰撞避免約束（靜態障礙物、動態障礙物）
     - 其他約束（如非完整性約束、全息機器人約束等）

4. **優化過程**：
   - 使用 g2o 優化器求解這個非線性優化問題
   - 多次迭代優化，最小化所有約束的加權誤差

5. **控制命令生成**：
   - 從優化後的軌跡中提取控制命令
   - 根據 lookahead distance 或其他策略選擇參考點
   - 根據參考點計算速度命令（線速度和角速度）

您的理解基本上涵蓋了這些關鍵步驟。唯一需要補充的是，最終的速度命令不僅僅依賴於 lookahead distance，而是基於優化後的軌跡結構（包括位姿和時間差）來計算的。TEB 優化器直接優化了時間維度，所以速度信息已經隱含在優化結果中，通常會使用前幾個位姿點和它們之間的時間差來計算控制命令。

此外，整個過程是循環執行的，每個控制週期都會重新進行優化，以適應環境變化和新的感知信息。


---


不完全是。在 TEB Local Planner 中，被優化的不是原始的全局路徑，而是基於全局路徑創建的 TEB 軌跡（即位姿序列和時間差序列）。

讓我再清晰地解釋一下這個過程：

1. **全局路徑作為參考**：
   - 全局路徑來自全局規劃器（如 A*、Dijkstra 等算法）
   - 全局路徑通常只是一系列位置點，沒有時間信息和動力學考慮

2. **TEB 軌跡初始化**：
   - 基於全局路徑創建初始的 TEB 軌跡
   - 這個 TEB 軌跡包含位姿頂點和時間差頂點

3. **優化對象**：
   - 優化器實際優化的是 TEB 軌跡，而不是原始的全局路徑
   - 優化過程中，位姿頂點的位置和朝向可能會變化，時間差頂點的值也會調整
   - 優化的目標是找到一條滿足所有約束（運動學、動力學、避障等）且成本最低的軌跡

4. **結果使用**：
   - 優化後的 TEB 軌跡用於生成控制命令
   - 每個控制週期重新優化，實現閉環控制

所以，被優化的是 TEB 軌跡這個本地規劃的結果，全局路徑只是提供了一個初始猜測和參考方向。TEB Planner 的強大之處在於它能夠同時優化空間路徑和時間分配，生成動態上可行的軌跡。